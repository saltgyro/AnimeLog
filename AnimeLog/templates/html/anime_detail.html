{% extends "html/base.html" %}
{% load static %}



{% block content %}
<script src="{% static 'js/anime_detail.js' %}" defer></script>
<link rel="stylesheet" href="{% static 'css/anime_detail.css' %}">

<div class="anime-detail-container">
    <a href="{% url 'anime_tracker:home' %}" class="back-link">戻る</a>
    <!-- 左側: サムネイル -->
    <div class="thumbnail">
        {% if anime.thumbnail %}
            <img src="{{ anime.thumbnail.url }}" alt="{{ anime.title }}" width="300">
        {% else %}
            <p>画像がありません</p>
        {% endif %}
    </div>

    <!-- 右側: アニメ情報 -->
    <div class="anime-info">
        <h2>{{ anime.title }}</h2>
        {% comment %} <div class="buttons">
            <!-- デバッグ用: user_relation を出力 -->
            <p>デバッグ: {{ user_relation }}</p>
            <p>デバッグ: {{ user_relation }}</p>


            <!-- 視聴済ボタン -->
            <button id="watched-btn" data-anime-id="{{ anime.id }}" data-status="watched"
            class="{% if user_relation and user_relation.status == 2 %}btn-active{% else %}btn-inactive{% endif %}">
                視聴済
            </button>


            <!-- お気に入りボタン -->
            <button id="favorite-btn" data-anime-id="{{ anime.id }}" data-status="favorite"
                    {% if not user.is_authenticated or user_relation.status != 2 %}disabled{% endif %}
                    class="{% if user_relation and user_relation.is_favorite %}btn-active{% else %}btn-inactive{% endif %}">
                お気に入り
            </button>



            <!-- 視聴予定ボタン -->
            <button id="plan-to-watch-btn" data-anime-id="{{ anime.id }}" data-status="plan_to_watch"
            class="{% if user_relation and user_relation.status == 1 %}btn-active{% else %}btn-inactive{% endif %}">
                視聴予定
            </button>


            {% if not user.is_authenticated %}
                <p>これらの機能を利用するにはログインしてください。</p>
            {% endif %}
        </div> {% endcomment %}
        <div class="buttons">
            <!-- 視聴済ボタン -->
            <button id="watched-btn"
                    data-anime-id="{{ anime.id }}"
                    data-status="watched"
                    {% if not user.is_authenticated %}disabled{% endif %}
                    class="{% if user_relation and user_relation.is_watched %}btn-active{% else %}btn-inactive{% endif %}"
                    onclick="toggleStatus('{{ anime.id }}', 'watched', this)">
                視聴済
            </button>
        
            <!-- お気に入りボタン -->
            <button id="favorite-btn"
                    data-anime-id="{{ anime.id }}"
                    data-status="favorite"
                    {% if not user.is_authenticated or not user_relation or not user_relation.is_watched %}disabled{% endif %}
                    class="{% if user_relation and user_relation.is_favorite %}btn-active{% else %}btn-inactive{% endif %}"
                    onclick="toggleStatus('{{ anime.id }}', 'favorite', this)">
                お気に入り
            </button>
        
            <!-- 視聴予定ボタン -->
            <button id="plan-to-watch-btn"
                    data-anime-id="{{ anime.id }}"
                    data-status="plan_to_watch"
                    {% if not user.is_authenticated %}disabled{% endif %}
                    class="{% if user_relation and user_relation.is_plan_to_watch %}btn-active{% else %}btn-inactive{% endif %}"
                    onclick="toggleStatus('{{ anime.id }}', 'plan_to_watch', this)">
                視聴予定
            </button>
        
            {% if not user.is_authenticated %}
                <p>これらの機能を利用するにはログインしてください。</p>
            {% endif %}
        </div>
        

        

        <div class="rating">
            <label for="rating-input">評価を入力してください (0〜5):</label>
            <input type="number" id="rating-input" min="0" max="5" step="0.1" value="{{ user_relation.rating|default:0.0 }}">
            <button id="rating-submit" data-anime-id="{{ anime.id }}">評価を更新</button>
        </div>

        {% if anime.synopsis %}
            <p><strong>あらすじ:</strong> {{ anime.synopsis }}</p>
        {% endif %}
        <p><strong>放送開始日:</strong> {{ anime.start_date }}</p>
        {% if anime.end_date %}
            <p><strong>放送終了日:</strong> {{ anime.end_date }}</p>
        {% endif %}
        {% if anime.episode_count > 0 %}
            <p><strong>総話数:</strong> {{ anime.episode_count }}</p>
        {% endif %}
        <p><strong>平均評価:</strong> {{ anime.average_rating }}</p>
        <p><strong>登録者数:</strong> {{ anime.watched_count }}</p>
        <p><strong>お気に入り数:</strong> {{ anime.favorite_count }}</p>


        <h3>タグ一覧</h3>
        <div class="all-tags">
            {% for tag in tags %}
                <button class="tag-button {% if tag in anime.tags.all %}active-tag{% else %}inactive-tag{% endif %}" 
                        data-tag-id="{{ tag.id }}" 
                        onclick="toggleTag(this, {{ anime.id }}, {{ tag.id }})">
                    {{ tag.name }}
                </button>
            {% empty %}
                <p>タグが登録されていません。</p>
            {% endfor %}
        </div>






        <h2>関連アニメ</h2>
        <div class="related-animes">
            <ul>
                {% for related_anime in related_animes %}
                    <li>
                        {% if related_anime.thumbnail %}
                            <a href="{% url 'anime_tracker:anime_detail' related_anime.id %}">
                                <img src="{{ related_anime.thumbnail.url }}" alt="{{ related_anime.title }}">
                            </a>
                        {% else %}
                            <p>サムネイルなし</p>
                        {% endif %}
                        <a href="{% url 'anime_tracker:anime_detail' related_anime.id %}">{{ related_anime.title }}</a>
                    </li>
                {% empty %}
                    <li>関連アニメはありません。</li>
                {% endfor %}
            </ul>
        </div>

    </div>
</div>


<script>
    {% comment %} const updateStatusUrl = "{% url 'anime_tracker:update_status' %}"; {% endcomment %}
    const updateStatusUrl = `{% url 'anime_tracker:update_status' pk=anime.id %}`;
    const csrfToken = "{{ csrf_token }}";

    function toggleTag(button, animeId, tagId) {
        const isActive = button.classList.contains('active-tag');
        const newState = !isActive; // 新しい状態を切り替え
    
        // サーバーに新しい状態を送信
        fetch(`/toggle-tag/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ anime_id: animeId, tag_id: tagId, active: newState })
        }).then(response => {
            if (response.ok) {
                // 成功時のリダイレクト（画面リロード）
                location.reload();  // ページをリロード
            } else {
                alert("タグ状態の更新に失敗しました。");
            }
        });
        {% comment %} }).then(response => {
            if (response.ok) {
                // ボタンの見た目を切り替え
                if (newState) {
                    button.classList.remove('inactive-tag');
                    button.classList.add('active-tag');
                } else {
                    button.classList.remove('active-tag');
                    button.classList.add('inactive-tag');
                }
            } else {
                alert("タグ状態の更新に失敗しました。");
            }
        }); {% endcomment %}
    }
    
</script>
<style>
    <!--
.btn-active {
    background-color: orange;
    color: white;
}

.btn-inactive {
    background-color: gray;
    color: white;
}

/* ホバー時のアクティブ状態のボタン */
.btn-active:hover {
    background-color: #ff8c00 !important; /* より濃いオレンジ */
    color: #fff !important;
}

/* ホバー時の非アクティブ状態のボタン */
.btn-inactive:hover {
    background-color: #d3d3d3 !important; /* より濃い灰色 */
    color: #000 !important;
}

    /* 関連付けられたタグを太字に */
.tag-button.active-tag {
    font-weight: bold;
    color: black; /* テキストの色を目立たせる */
}

/* 関連付けられていないタグを薄字に */
.tag-button.inactive-tag {
    font-weight: normal;
    color: gray; /* テキストを薄い色に */
}

/* ボタン全体のデフォルトスタイル */
.tag-button {
    background-color: transparent; /* ボタンの背景を透明に */
    border: 1px solid #ccc; /* 枠線を追加 */
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 5px;
    margin: 5px;
}

    -->
</style>

{% endblock %}
