{% extends "html/base.html" %}
{% load static %}



{% block content %}
<script src="{% static 'js/anime_detail.js' %}" defer></script>
<link rel="stylesheet" href="{% static 'css/anime_detail.css' %}">

<div class="anime-detail-container">
    <a href="{% url 'anime_tracker:home' %}" class="back-link">戻る</a>
    <!-- 左側: サムネイル -->
    <div class="thumbnail">
        {% if anime.thumbnail %}
            <img src="{{ anime.thumbnail.url }}" alt="{{ anime.title }}" width="300">
        {% else %}
            <p>画像がありません</p>
        {% endif %}
    </div>

    <!-- 右側: アニメ情報 -->
    <div class="anime-info">
        <h2>{{ anime.title }}</h2>
        {% comment %} <div class="buttons">
            <!-- デバッグ用: user_relation を出力 -->
            <p>デバッグ: {{ user_relation }}</p>
            <p>デバッグ: {{ user_relation }}</p>


            <!-- 視聴済ボタン -->
            <button id="watched-btn" data-anime-id="{{ anime.id }}" data-status="watched"
            class="{% if user_relation and user_relation.status == 2 %}btn-active{% else %}btn-inactive{% endif %}">
                視聴済
            </button>


            <!-- お気に入りボタン -->
            <button id="favorite-btn" data-anime-id="{{ anime.id }}" data-status="favorite"
                    {% if not user.is_authenticated or user_relation.status != 2 %}disabled{% endif %}
                    class="{% if user_relation and user_relation.is_favorite %}btn-active{% else %}btn-inactive{% endif %}">
                お気に入り
            </button>



            <!-- 視聴予定ボタン -->
            <button id="plan-to-watch-btn" data-anime-id="{{ anime.id }}" data-status="plan_to_watch"
            class="{% if user_relation and user_relation.status == 1 %}btn-active{% else %}btn-inactive{% endif %}">
                視聴予定
            </button>


            {% if not user.is_authenticated %}
                <p>これらの機能を利用するにはログインしてください。</p>
            {% endif %}
        </div> {% endcomment %}
        <div class="buttons">
            <!-- 視聴済ボタン -->
            <button id="watched-btn"
                    data-anime-id="{{ anime.id }}"
                    data-status="watched"
                    {% if not user.is_authenticated %}disabled{% endif %}
                    class="{% if user_relation and user_relation.is_watched %}btn-active{% else %}btn-inactive{% endif %}"
                    onclick="toggleStatus('{{ anime.id }}', 'watched', this)">
                視聴済
            </button>
        
            <!-- お気に入りボタン -->
            <button id="favorite-btn"
                    data-anime-id="{{ anime.id }}"
                    data-status="favorite"
                    {% if not user.is_authenticated or not user_relation or not user_relation.is_watched %}disabled{% endif %}
                    class="{% if user_relation and user_relation.is_favorite %}btn-active{% else %}btn-inactive{% endif %}"
                    onclick="toggleStatus('{{ anime.id }}', 'favorite', this)">
                お気に入り
            </button>
        
            <!-- 視聴予定ボタン -->
            <button id="plan-to-watch-btn"
                    data-anime-id="{{ anime.id }}"
                    data-status="plan_to_watch"
                    {% if not user.is_authenticated %}disabled{% endif %}
                    class="{% if user_relation and user_relation.is_plan_to_watch %}btn-active{% else %}btn-inactive{% endif %}"
                    onclick="toggleStatus('{{ anime.id }}', 'plan_to_watch', this)">
                視聴予定
            </button>
        
            {% if not user.is_authenticated %}
                <p>これらの機能を利用するにはログインしてください。</p>
            {% endif %}
        </div>
        

        

        {% comment %} <div class="rating">
            <label for="rating-input">評価を入力してください (0〜5):</label>
            <input type="number" id="rating-input" min="0" max="5" step="0.1" value="{{ user_relation.rating|default:0.0 }}">
            <button id="rating-submit" data-anime-id="{{ anime.id }}">評価を更新</button>
        </div> {% endcomment %}
        <div class="anime-rating">
            <!-- 評価星の表示 -->
            <div class="card-review_star" data-anime-id="{{ anime.id }}" data-rating="{{ user_relation.rating|default:0 }}"></div>
        
            <!-- ログインしている場合、ユーザーの評価を表示 -->
            {% if user.is_authenticated %}
            <div class="user-rating">
                あなたの評価: <span id="user-rating">{{ user_relation.rating }}</span>
            </div>
            
            <div class="rating-action">
                <p>クリックして評価を変更</p>
            </div>
            {% else %}
            <div class="rating-disabled">
                <p>ログインして評価を変更できます</p>
            </div>
            {% endif %}
        </div>
        
        
        

        
        
        

        {% if anime.synopsis %}
            <p><strong>あらすじ:</strong> {{ anime.synopsis }}</p>
        {% endif %}
        <p><strong>放送開始日:</strong> {{ anime.start_date }}</p>
        {% if anime.end_date %}
            <p><strong>放送終了日:</strong> {{ anime.end_date }}</p>
        {% endif %}
        {% if anime.episode_count > 0 %}
            <p><strong>総話数:</strong> {{ anime.episode_count }}</p>
        {% endif %}
        <p><strong>平均評価:</strong> {{ anime.average_rating }}</p>
        <p><strong>登録者数:</strong> {{ anime.watched_count }}</p>
        <p><strong>お気に入り数:</strong> {{ anime.favorite_count }}</p>


        <h3>タグ一覧</h3>
        <div class="all-tags">
            {% for tag in tags %}
                <button class="tag-button {% if tag in anime.tags.all %}active-tag{% else %}inactive-tag{% endif %}" 
                        data-tag-id="{{ tag.id }}" 
                        onclick="toggleTag(this, {{ anime.id }}, {{ tag.id }})">
                    {{ tag.name }}
                </button>
            {% empty %}
                <p>タグが登録されていません。</p>
            {% endfor %}
        </div>






        <h2>関連アニメ</h2>
        <div class="related-animes">
            <ul>
                {% for related_anime in related_animes %}
                    <li>
                        {% if related_anime.thumbnail %}
                            <a href="{% url 'anime_tracker:anime_detail' related_anime.id %}">
                                <img src="{{ related_anime.thumbnail.url }}" alt="{{ related_anime.title }}">
                            </a>
                        {% else %}
                            <p>サムネイルなし</p>
                        {% endif %}
                        <a href="{% url 'anime_tracker:anime_detail' related_anime.id %}">{{ related_anime.title }}</a>
                    </li>
                {% empty %}
                    <li>関連アニメはありません。</li>
                {% endfor %}
            </ul>
        </div>

    </div>
</div>


<script>
    {% comment %} const updateStatusUrl = "{% url 'anime_tracker:update_status' %}"; {% endcomment %}
    const updateStatusUrl = `{% url 'anime_tracker:update_status' pk=anime.id %}`;
    const csrfToken = "{{ csrf_token }}";

    function toggleTag(button, animeId, tagId) {
        const isActive = button.classList.contains('active-tag');
        const newState = !isActive; // 新しい状態を切り替え
    
        // サーバーに新しい状態を送信
        fetch(`/toggle-tag/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ anime_id: animeId, tag_id: tagId, active: newState })
        }).then(response => {
            if (response.ok) {
                // 成功時のリダイレクト（画面リロード）
                location.reload();  // ページをリロード
            } else {
                alert("タグ状態の更新に失敗しました。");
            }
        });
        {% comment %} }).then(response => {
            if (response.ok) {
                // ボタンの見た目を切り替え
                if (newState) {
                    button.classList.remove('inactive-tag');
                    button.classList.add('active-tag');
                } else {
                    button.classList.remove('active-tag');
                    button.classList.add('inactive-tag');
                }
            } else {
                alert("タグ状態の更新に失敗しました。");
            }
        }); {% endcomment %}
    }



// 以下が星に関するJavaスクリプト
const createStar = () => {
    const starElement = document.querySelector('.card-review_star');
    const userRatingElement = document.querySelector('#user-rating'); // ユーザー評価の表示エリア
    const averageRatingElement = document.querySelector('#average-rating'); // 平均評価の表示エリア
    const review = parseFloat(starElement.getAttribute('data-rating')) || 0; // 現在の評価値
    const animeId = starElement.getAttribute('data-anime-id'); // アニメのID

    // 初期表示で星の幅を設定
    const widthPercentage = review * 20; // 評価を%に変換（5.0 -> 100%）
    starElement.style.setProperty('--starWidth', `${widthPercentage}%`);
    
    //ホバー時の動作、
    starElement.addEventListener('mousemove', (event) => {
        console.log("mousemoveイベントが発火しました"); // ログを追加
        const rect = starElement.getBoundingClientRect();
        const offsetX = event.clientX - rect.left;
        const hoverRating = Math.min(Math.max((offsetX / rect.width) * 5, 0), 5).toFixed(1);
        console.log("ホバー中の評価:", hoverRating); // ログを追加
    
        updateStarWidth(starElement, hoverRating);
    
        if (userRatingElement) {
            userRatingElement.textContent = hoverRating;
        }
    });
    

    // 星をクリックして評価を更新
    starElement.addEventListener('click', (event) => {
        const rect = starElement.getBoundingClientRect();
        const offsetX = event.clientX - rect.left;
        const newRating = Math.min(Math.max((offsetX / rect.width) * 5, 0), 5).toFixed(1); // 新しい評価値
        starElement.setAttribute('data-rating', newRating); // 星の評価を更新

        console.log("新しい評価:", newRating); // デバッグ用

        // 評価をサーバーに送信
        fetch(`/update_rating/${animeId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({ rating: parseFloat(newRating) }),
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTPエラー: ${response.status}`);
                }
                return response.json();
            })
            .then((data) => {
                console.log('評価が更新されました:', data);

                if (data.user_rating !== undefined) {
                    userRatingElement.textContent = data.user_rating.toFixed(1);
                } else {
                    console.error('user_rating がレスポンスに含まれていません');
                }

                {% comment %} // ユーザー評価要素を更新
                let userRatingElement = document.querySelector('#user-rating');
                if (userRatingElement) {
                    userRatingElement.textContent = data.user_rating.toFixed(1);
                } else {
                    console.error("ユーザー評価要素が見つかりません");
                } {% endcomment %}

                // 動的にUIを更新
                userRatingElement.textContent = newRating; // ユーザー評価を更新
                {% comment %} averageRatingElement.textContent = data.average_rating.toFixed(1); // 平均評価を更新 {% endcomment %}
                updateStarWidth(starElement, newRating); // 星評価を更新
                window.location.reload();
            })
            .catch((error) => {
                console.error('エラーが発生しました:', error);
            });
    });

    // 星の塗りつぶし幅を更新する関数
    const updateStarWidth = (element, rating) => {
        const percentage = (rating / 5) * 100;
        console.log('星の塗りつぶし幅:', percentage); // デバッグ用
        element.style.setProperty('--starWidth', `${percentage}%`);
    };
};

// スター評価を初期化
createStar();




    
    
</script>
<style>
    <!--
.btn-active {
    background-color: orange;
    color: white;
}

.btn-inactive {
    background-color: gray;
    color: white;
}

/* ホバー時のアクティブ状態のボタン */
.btn-active:hover {
    background-color: #ff8c00 !important; /* より濃いオレンジ */
    color: #fff !important;
}

/* ホバー時の非アクティブ状態のボタン */
.btn-inactive:hover {
    background-color: #d3d3d3 !important; /* より濃い灰色 */
    color: #000 !important;
}

    /* 関連付けられたタグを太字に */
.tag-button.active-tag {
    font-weight: bold;
    color: black; /* テキストの色を目立たせる */
}

/* 関連付けられていないタグを薄字に */
.tag-button.inactive-tag {
    font-weight: normal;
    color: gray; /* テキストを薄い色に */
}

/* ボタン全体のデフォルトスタイル */
.tag-button {
    background-color: transparent; /* ボタンの背景を透明に */
    border: 1px solid #ccc; /* 枠線を追加 */
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 5px;
    margin: 5px;
}
/* 以下星に関して */



.card-review_star {
    position: relative;
    display: inline-block;
    font-size: 36px; /* 星のサイズ */
    width: 180px; /* 星5つ分の幅 */
    cursor: pointer;
}

.card-review_star::before {
    content: "★★★★★";
    color: #CCCCCC; /* 星の土台色 */
}



.card-review_star::after {
    content: "★★★★★"; /* 塗りつぶし用の星 */
    position: absolute;
    width: var(--starWidth, 0%); /* 塗りつぶし幅 */
    z-index: 1;
    top: 0;
    left: 0;
    overflow: hidden;
    white-space: nowrap;
    color: #ffcf32;
}

.rating-disabled {
    color: #888888;
    font-size: 14px;
    margin-top: 5px;
}

.rating-action {
    color: #000;
    font-size: 14px;
    margin-top: 5px;
    cursor: pointer;
}







/* ホバー時のフィードバック */
.card-review_star.hovering::after {
    color: #ffd700; /* ホバー中の明るい黄色 */
}



    -->
</style>

{% endblock %}
