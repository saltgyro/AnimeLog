{% extends "html/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">

<button class="btn btn-primary m-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
    ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
</button>
<!-- ã‚ªãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="é–‰ã˜ã‚‹"></button>
    </div>
    <div class="offcanvas-body">
        <h6>æ¤œç´¢æ¡ä»¶</h6>
        <ul>
            <!-- ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ -->
            {% if search_conditions.search %}
            <li>ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢: 
                {% for keyword in search_conditions.search %}
                    <span>{{ keyword }}
                        <button class="btn btn-sm btn-danger remove-condition" data-type="search" data-value="{{ keyword }}">Ã—</button>
                    </span>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </li>
            {% endif %}
            
            <!-- ã‚¸ãƒ£ãƒ³ãƒ« -->
            {% if search_conditions.genre %}
                <li>ã‚¸ãƒ£ãƒ³ãƒ«: 
                    {% for genre in genres %}
                        {% if genre.id|stringformat:"s" in search_conditions.genre %}
                            <span>{{ genre.name }}
                                <button class="btn btn-sm btn-danger remove-condition" data-type="genre" data-value="{{ genre.id }}">Ã—</button>

                            </span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endif %}

            <!-- ã‚¿ã‚° -->
            {% if search_conditions.tag %}
                <li>ã‚¿ã‚°: 
                    {% for tag in tags %}
                        {% if tag.id|stringformat:"s" in search_conditions.tag %}
                            <span>{{ tag.name }}
                                <button class="btn btn-sm btn-danger remove-condition" data-type="tag" data-value="{{ tag.id }}">Ã—</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endif %}

            <!-- ã‚·ãƒ¼ã‚ºãƒ³ -->
            {% if search_conditions.season %}
                <li>ã‚·ãƒ¼ã‚ºãƒ³: 
                    {% for season in seasons %}
                        {% if season.id|stringformat:"s" in search_conditions.season %}
                            <span>{{ season.year }} å¹´ {{ season.get_season_display }}
                                <button class="btn btn-sm btn-danger remove-condition" data-type="season" data-value="{{ season.id }}">Ã—</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endif %}

            <!-- ã‚¹ã‚¿ã‚¸ã‚ª -->
            {% if search_conditions.studio %}
                <li>ã‚¹ã‚¿ã‚¸ã‚ª: 
                    {% for studio in studios %}
                        {% if studio.id|stringformat:"s" in search_conditions.studio %}
                            <span>{{ studio.name }}
                                <button class="btn btn-sm btn-danger remove-condition" data-type="studio" data-value="{{ studio.id }}">Ã—</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endif %}
        </ul>

        <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
        <div class="offcanvas-footer">
            <button class="btn btn-danger m-3" id="reset-search">æ¤œç´¢ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <span>è©³ç´°ç”»é¢</span>
        <label class="switch">
            <input type="checkbox" id="toggle-detail">
            <span class="slider"></span>
        </label>

        <ul class="list-unstyled">
            

                <li>
                    <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#genreMenu" aria-expanded="false" aria-controls="genreMenu">ğŸ­ ã‚¸ãƒ£ãƒ³ãƒ«</a>
                    <div id="genreMenu" class="collapse">
                        {% for genre in genres %}
                            <button 
                                class="btn btn-outline-primary genre-button" 
                                data-type="genre" 
                                data-id="{{ genre.id }}">
                                {{ genre.name }}
                            </button>
                        {% endfor %}
                    </div>
                </li>

            

                <li>
                    <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#tagMenu" aria-expanded="false" aria-controls="tagMenu">ğŸ· ã‚¿ã‚°</a>
                    <div id="tagMenu" class="collapse">
                        {% for tag in tags %}
                            <button 
                                class="btn btn-outline-primary tag-button" 
                                data-type="tag" 
                                data-id="{{ tag.id }}">
                                {{ tag.name }}
                            </button>
                        {% endfor %}
                    </div>
                </li>

            

                <li>
                    <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#seasonMenu" aria-expanded="false" aria-controls="seasonMenu">ğŸ“… å¹´ä»£</a>
                    <div id="seasonMenu" class="collapse">
                        {% for season in seasons %}
                            <button 
                                class="btn btn-outline-primary season-button" 
                                data-type="season" 
                                data-id="{{ season.id }}">
                                {{ season.year}} å¹´ {{ season.get_season_display }}
                            </button>
                        {% endfor %}
                    </div>
                </li>

                
                <li>
                    <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#studioMenu" aria-expanded="false" aria-controls="studioMenu">ğŸ¬ åˆ¶ä½œã‚¹ã‚¿ã‚¸ã‚ª</a>
                    <div id="studioMenu" class="collapse">
                        {% for studio in studios %}
                            <button 
                                class="btn btn-outline-primary studio-button" 
                                data-type="studio" 
                                data-id="{{ studio.id }}">
                                {{ studio.name }}
                            </button>
                        {% endfor %}
                    </div>
                </li>
        </ul>
    </div>
</div>

<div class="filters">
    <a href="{% url 'anime_tracker:home' %}?status=not_in_list" 
    class="btn btn-primary filter-btn {% if request.GET.status != 'watched' and request.GET.status != 'favorite' and request.GET.status != 'plan_to_watch' %}selected{% endif %}">
    å…¨ä½œå“
    </a>
    
    {% if request.user.is_authenticated %}
        <a href="{% url 'anime_tracker:home' %}?status=watched" 
        class="btn btn-primary filter-btn {% if request.GET.status == 'watched' %}selected{% endif %}">
        è¦–è´æ¸ˆã¿
        </a>
        <a href="{% url 'anime_tracker:home' %}?status=favorite" 
        class="btn btn-primary filter-btn {% if request.GET.status == 'favorite' %}selected{% endif %}">
        ãŠæ°—ã«å…¥ã‚Š
        </a>
        <a href="{% url 'anime_tracker:home' %}?status=plan_to_watch" 
        class="btn btn-primary filter-btn {% if request.GET.status == 'plan_to_watch' %}selected{% endif %}">
        è¦–è´äºˆå®š
        </a>
    {% else %}
        <!-- æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ– -->
        <a class="btn btn-secondary disabled" aria-disabled="true" tabindex="-1">è¦–è´æ¸ˆã¿</a>
        <a class="btn btn-secondary disabled" aria-disabled="true" tabindex="-1">ãŠæ°—ã«å…¥ã‚Š</a>
        <a class="btn btn-secondary disabled" aria-disabled="true" tabindex="-1">è¦–è´äºˆå®š</a>
    {% endif %}
</div>



<!-- ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
<div class="sort-options mb-3 d-flex justify-content-end">
    <label for="sort-select" class="form-label">ä¸¦ã³é †:</label>
    <select id="sort-select" class="form-select" onchange="applySort()">
        <option value="season-desc" {% if request.GET.sort == 'season-desc' %}selected{% endif %}>ã‚·ãƒ¼ã‚ºãƒ³ï¼ˆæ–°ã—ã„é †ï¼‰</option>
        <option value="season-asc" {% if request.GET.sort == 'season-asc' %}selected{% endif %}>ã‚·ãƒ¼ã‚ºãƒ³ï¼ˆå¤ã„é †ï¼‰</option>
        <option value="average_rating" {% if request.GET.sort == 'average_rating' %}selected{% endif %}>äººæ°—é †</option>
        <option value="watched_count-desc" {% if request.GET.sort == 'watched_count-desc' %}selected{% endif %}>ç™»éŒ²æ•°é †</option>
    </select>
</div>

<div class="search-results">
    <div class="anime-list">
        {% for anime in page_obj %}
            <div class="anime-item">
                <a href="{% url 'anime_tracker:anime_detail' anime.id %}">
                    {% if anime.thumbnail %}
                        <img src="{{ anime.thumbnail.url }}" alt="{{ anime.title }}" width="150">
                    {% else %}
                        <p>ç”»åƒãªã—</p>
                    {% endif %}
                    <p>{{ anime.title }}</p>
                </a>

                <div class="anime-detail" style="display: none;">
                    <p><strong>æ”¾é€é–‹å§‹æ—¥:</strong> {{ anime.start_date }}</p>
                    {% if anime.end_date %}
                        <p><strong>æ”¾é€çµ‚äº†æ—¥:</strong> {{ anime.end_date }}</p>
                    {% endif %}
                    {% if anime.episode_count > 0 %}
                        <p><strong>ç·è©±æ•°:</strong> {{ anime.episode_count }}</p>
                    {% endif %}
                    <p><strong>å¹³å‡è©•ä¾¡:</strong> {{ anime.average_rating }}</p>
                    <p><strong>ç™»éŒ²è€…æ•°:</strong> {{ anime.watched_count }}</p>
                    <p><strong>ãŠæ°—ã«å…¥ã‚Šæ•°:</strong> {{ anime.favorite_count }}</p>
                </div>
            </div>
        {% empty %}
            <p>è©²å½“ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endfor %}
    </div>
    
    
    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="pagination">
        <!-- æœ€åˆã®ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ -->
        {% if page_obj.has_previous %}
            <a href="?page=1" class="first-page">Â«</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="prev-page">ï¼œå‰ã®ãƒšãƒ¼ã‚¸</a>
        {% endif %}
    
        <!-- ãƒšãƒ¼ã‚¸ç•ªå·ã®ãƒ«ãƒ¼ãƒ— -->
        {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
                <span class="page-number active">{{ num }}</span> <!-- ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã¯å¼·èª¿è¡¨ç¤º -->
            {% else %}
                <a href="?page={{ num }}" class="page-number">{{ num }}</a>
            {% endif %}
        {% endfor %}
    
        <!-- æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ -->
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="next-page">æ¬¡ã®ãƒšãƒ¼ã‚¸ï¼</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="last-page">Â»</a>
        {% endif %}
    </div>
</div>


<script>
    // è©³ç´°ç”»é¢ç”¨ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
    const detailToggleButton = document.getElementById("toggle-detail");
    const animeDetails = document.querySelectorAll('.anime-detail');
    console.log("AA")
    // è©³ç´°æƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤º
    detailToggleButton.addEventListener("change", function () {
        if (detailToggleButton.checked) {
            animeDetails.forEach(function(detail) {
                detail.style.display = 'block';  // è©³ç´°ã‚’è¡¨ç¤º
                console.log("HEI")
            });
        } else {
            animeDetails.forEach(function(detail) {
                detail.style.display = 'none';  // è©³ç´°ã‚’éè¡¨ç¤º
            });
        }
    });

    // åˆæœŸçŠ¶æ…‹ã®è¨­å®šï¼ˆãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤º/éè¡¨ç¤ºï¼‰
    if (detailToggleButton.checked) {
        animeDetails.forEach(function(detail) {
            console.log("Foo")
            detail.style.display = 'block';  // è©³ç´°ã‚’è¡¨ç¤º
        });
    } else {
        animeDetails.forEach(function(detail) {
            detail.style.display = 'none';  // è©³ç´°ã‚’éè¡¨ç¤º
        });
    }
    
    document.addEventListener("DOMContentLoaded", function() {
        // å…¨ã¦ã® "remove-condition" ãƒœã‚¿ãƒ³ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
        const buttons = document.querySelectorAll(".remove-condition");
        buttons.forEach(button => {
            button.addEventListener("click", function(event) {
                event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯å‹•ä½œã‚’é˜²ã
                
                // ãƒœã‚¿ãƒ³ã‹ã‚‰æ¡ä»¶ã‚¿ã‚¤ãƒ—ã¨å€¤ã‚’å–å¾—
                const type = this.getAttribute("data-type");
                const value = this.getAttribute("data-value");

                // ç¾åœ¨ã®URLã‚’å–å¾—ã—ã¦ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ“ä½œ
                const url = new URL(window.location.href);
                const params = url.searchParams;

                // è©²å½“ã™ã‚‹æ¡ä»¶ã‚’å‰Šé™¤
                const values = params.getAll(type); // ã™ã¹ã¦ã®å€¤ã‚’å–å¾—
                params.delete(type); // ã¾ãšãã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                values.forEach(val => {
                    if (val !== value) { // å‰Šé™¤å¯¾è±¡ä»¥å¤–ã‚’å†è¿½åŠ 
                        params.append(type, val);
                    }
                });

                // æ–°ã—ã„URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = url.toString();
            });
        });
    });
    
    

    

</script>
{% endblock %}


