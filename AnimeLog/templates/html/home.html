{% extends "html/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">

<button class="btn btn-primary m-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
    メニューを開く
</button>
<!-- オフキャンバスメニュー -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">メニュー</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="閉じる"></button>
    </div>
    <div class="offcanvas-body">
        <h6>検索条件</h6>
        <ul>
            <!-- フリーワード検索 -->
            {% if search_conditions.search %}
            <li>フリーワード検索: 
                {% for keyword in search_conditions.search %}
                    <span>{{ keyword }}
                        <button class="btn btn-sm btn-danger remove-condition" data-type="search" data-value="{{ keyword }}">×</button>
                    </span>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </li>
            {% endif %}
            
            <!-- ジャンル -->
            {% if search_conditions.genre %}
                <li>ジャンル: 
                    {% for genre in genres %}
                        {% if genre.id|stringformat:"s" in search_conditions.genre %}
                            <span>{{ genre.name }}
                                <button class="btn btn-sm btn-danger remove-condition" data-type="genre" data-value="{{ genre.id }}">×</button>

                            </span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endif %}

            <!-- タグ -->
            {% if search_conditions.tag %}
                <li>タグ: 
                    {% for tag in tags %}
                        {% if tag.id|stringformat:"s" in search_conditions.tag %}
                            <span>{{ tag.name }}
                                <button class="btn btn-sm btn-danger remove-condition" data-type="tag" data-value="{{ tag.id }}">×</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endif %}

            <!-- シーズン -->
            {% if search_conditions.season %}
                <li>シーズン: 
                    {% for season in seasons %}
                        {% if season.id|stringformat:"s" in search_conditions.season %}
                            <span>{{ season.year }} 年 {{ season.get_season_display }}
                                <button class="btn btn-sm btn-danger remove-condition" data-type="season" data-value="{{ season.id }}">×</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endif %}

            <!-- スタジオ -->
            {% if search_conditions.studio %}
                <li>スタジオ: 
                    {% for studio in studios %}
                        {% if studio.id|stringformat:"s" in search_conditions.studio %}
                            <span>{{ studio.name }}
                                <button class="btn btn-sm btn-danger remove-condition" data-type="studio" data-value="{{ studio.id }}">×</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endif %}
        </ul>

        <!-- リセットボタン -->
        <div class="offcanvas-footer">
            <button class="btn btn-danger m-3" id="reset-search">検索リセット</button>
        </div>
        
        <span>詳細画面</span>
        <label class="switch">
            <input type="checkbox" id="toggle-detail">
            <span class="slider"></span>
        </label>

        <ul class="list-unstyled">
            

                <li>
                    <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#genreMenu" aria-expanded="false" aria-controls="genreMenu">🎭 ジャンル</a>
                    <div id="genreMenu" class="collapse">
                        {% for genre in genres %}
                            <button 
                                class="btn btn-outline-primary genre-button" 
                                data-type="genre" 
                                data-id="{{ genre.id }}">
                                {{ genre.name }}
                            </button>
                        {% endfor %}
                    </div>
                </li>

            

                <li>
                    <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#tagMenu" aria-expanded="false" aria-controls="tagMenu">🏷 タグ</a>
                    <div id="tagMenu" class="collapse">
                        {% for tag in tags %}
                            <button 
                                class="btn btn-outline-primary tag-button" 
                                data-type="tag" 
                                data-id="{{ tag.id }}">
                                {{ tag.name }}
                            </button>
                        {% endfor %}
                    </div>
                </li>

            

                <li>
                    <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#seasonMenu" aria-expanded="false" aria-controls="seasonMenu">📅 年代</a>
                    <div id="seasonMenu" class="collapse">
                        {% for season in seasons %}
                            <button 
                                class="btn btn-outline-primary season-button" 
                                data-type="season" 
                                data-id="{{ season.id }}">
                                {{ season.year}} 年 {{ season.get_season_display }}
                            </button>
                        {% endfor %}
                    </div>
                </li>

                
                <li>
                    <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#studioMenu" aria-expanded="false" aria-controls="studioMenu">🎬 制作スタジオ</a>
                    <div id="studioMenu" class="collapse">
                        {% for studio in studios %}
                            <button 
                                class="btn btn-outline-primary studio-button" 
                                data-type="studio" 
                                data-id="{{ studio.id }}">
                                {{ studio.name }}
                            </button>
                        {% endfor %}
                    </div>
                </li>
        </ul>
    </div>
</div>

<div class="filters">
    <a href="{% url 'anime_tracker:home' %}?status=not_in_list" 
    class="btn btn-primary filter-btn {% if request.GET.status != 'watched' and request.GET.status != 'favorite' and request.GET.status != 'plan_to_watch' %}selected{% endif %}">
    全作品
    </a>
    
    {% if request.user.is_authenticated %}
        <a href="{% url 'anime_tracker:home' %}?status=watched" 
        class="btn btn-primary filter-btn {% if request.GET.status == 'watched' %}selected{% endif %}">
        視聴済み
        </a>
        <a href="{% url 'anime_tracker:home' %}?status=favorite" 
        class="btn btn-primary filter-btn {% if request.GET.status == 'favorite' %}selected{% endif %}">
        お気に入り
        </a>
        <a href="{% url 'anime_tracker:home' %}?status=plan_to_watch" 
        class="btn btn-primary filter-btn {% if request.GET.status == 'plan_to_watch' %}selected{% endif %}">
        視聴予定
        </a>
    {% else %}
        <!-- 未ログイン時はボタンを無効化 -->
        <a class="btn btn-secondary disabled" aria-disabled="true" tabindex="-1">視聴済み</a>
        <a class="btn btn-secondary disabled" aria-disabled="true" tabindex="-1">お気に入り</a>
        <a class="btn btn-secondary disabled" aria-disabled="true" tabindex="-1">視聴予定</a>
    {% endif %}
</div>



<!-- ソートボタン -->
<div class="sort-options mb-3 d-flex justify-content-end">
    <label for="sort-select" class="form-label">並び順:</label>
    <select id="sort-select" class="form-select" onchange="applySort()">
        <option value="season-desc" {% if request.GET.sort == 'season-desc' %}selected{% endif %}>シーズン（新しい順）</option>
        <option value="season-asc" {% if request.GET.sort == 'season-asc' %}selected{% endif %}>シーズン（古い順）</option>
        <option value="average_rating" {% if request.GET.sort == 'average_rating' %}selected{% endif %}>人気順</option>
        <option value="watched_count-desc" {% if request.GET.sort == 'watched_count-desc' %}selected{% endif %}>登録数順</option>
    </select>
</div>

<div class="search-results">
    <div class="anime-list">
        {% for anime in page_obj %}
            <div class="anime-item">
                <a href="{% url 'anime_tracker:anime_detail' anime.id %}">
                    {% if anime.thumbnail %}
                        <img src="{{ anime.thumbnail.url }}" alt="{{ anime.title }}" width="150">
                    {% else %}
                        <p>画像なし</p>
                    {% endif %}
                    <p>{{ anime.title }}</p>
                </a>

                <div class="anime-detail" style="display: none;">
                    <p><strong>放送開始日:</strong> {{ anime.start_date }}</p>
                    {% if anime.end_date %}
                        <p><strong>放送終了日:</strong> {{ anime.end_date }}</p>
                    {% endif %}
                    {% if anime.episode_count > 0 %}
                        <p><strong>総話数:</strong> {{ anime.episode_count }}</p>
                    {% endif %}
                    <p><strong>平均評価:</strong> {{ anime.average_rating }}</p>
                    <p><strong>登録者数:</strong> {{ anime.watched_count }}</p>
                    <p><strong>お気に入り数:</strong> {{ anime.favorite_count }}</p>
                </div>
            </div>
        {% empty %}
            <p>該当するアニメはありません。</p>
        {% endfor %}
    </div>
    
    
    <!-- ページネーション -->
    <div class="pagination">
        <!-- 最初のページへのリンク -->
        {% if page_obj.has_previous %}
            <a href="?page=1" class="first-page">«</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="prev-page">＜前のページ</a>
        {% endif %}
    
        <!-- ページ番号のループ -->
        {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
                <span class="page-number active">{{ num }}</span> <!-- 現在のページは強調表示 -->
            {% else %}
                <a href="?page={{ num }}" class="page-number">{{ num }}</a>
            {% endif %}
        {% endfor %}
    
        <!-- 次のページへのリンク -->
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="next-page">次のページ＞</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="last-page">»</a>
        {% endif %}
    </div>
</div>


<script>
    // 詳細画面用のトグルボタン
    const detailToggleButton = document.getElementById("toggle-detail");
    const animeDetails = document.querySelectorAll('.anime-detail');
    console.log("AA")
    // 詳細情報の表示/非表示
    detailToggleButton.addEventListener("change", function () {
        if (detailToggleButton.checked) {
            animeDetails.forEach(function(detail) {
                detail.style.display = 'block';  // 詳細を表示
                console.log("HEI")
            });
        } else {
            animeDetails.forEach(function(detail) {
                detail.style.display = 'none';  // 詳細を非表示
            });
        }
    });

    // 初期状態の設定（トグルボタンの状態に応じて表示/非表示）
    if (detailToggleButton.checked) {
        animeDetails.forEach(function(detail) {
            console.log("Foo")
            detail.style.display = 'block';  // 詳細を表示
        });
    } else {
        animeDetails.forEach(function(detail) {
            detail.style.display = 'none';  // 詳細を非表示
        });
    }
    
    document.addEventListener("DOMContentLoaded", function() {
        // 全ての "remove-condition" ボタンにクリックイベントを追加
        const buttons = document.querySelectorAll(".remove-condition");
        buttons.forEach(button => {
            button.addEventListener("click", function(event) {
                event.preventDefault(); // デフォルトのリンク動作を防ぐ
                
                // ボタンから条件タイプと値を取得
                const type = this.getAttribute("data-type");
                const value = this.getAttribute("data-value");

                // 現在のURLを取得してクエリパラメータを操作
                const url = new URL(window.location.href);
                const params = url.searchParams;

                // 該当する条件を削除
                const values = params.getAll(type); // すべての値を取得
                params.delete(type); // まずそのパラメータを削除
                values.forEach(val => {
                    if (val !== value) { // 削除対象以外を再追加
                        params.append(type, val);
                    }
                });

                // 新しいURLにリダイレクト
                window.location.href = url.toString();
            });
        });
    });
    
    

    

</script>
{% endblock %}


